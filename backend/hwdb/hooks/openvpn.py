"""OpenVPN config generator."""

from logging import getLogger
from pathlib import Path
from subprocess import CalledProcessError

from hwdb.config import CONFIG
from hwdb.orm.system import System
from hwdb.system import root, systemctl


__all__ = ['openvpncfgen']


LOGGER = getLogger('openvpn')
OPENVPN_SERVICE = 'openvpn-server@terminals.service'
TEMPLATE = '''
# Generated by openvpncfg-gen.
# DO NOT EDIT THIS FILE MANUALLY!
# System #{id}.

ifconfig-push {ipv4address} {netmask}
route 10.8.0.0 255.255.0.0
route 10.200.200.0 255.255.255.0 {ipv4address}
'''     # Mandatory empty line at end of file.
CLIENTS_DIR = Path(CONFIG['OpenVPN']['clients_dir'])


def generate_config(system):
    """Returns the OpenVPN configuration for the respective system."""

    openvpn = system.openvpn

    if openvpn is None:
        LOGGER.error('Terminal %i has no VPN configuration.', system.id)
        return

    config_text = TEMPLATE.format(
        id=system.id, ipv4address=openvpn.ipv4address,
        netmask=CONFIG['OpenVPN']['netmask'])
    file_name = openvpn.key or str(openvpn.id)
    file_path = CLIENTS_DIR.joinpath(file_name)

    with file_path.open('w') as cfg:
        cfg.write(config_text)


def generate_configs():
    """Generates the respective configuration files."""

    for system in System:
        generate_config(system)


@root(LOGGER)
def openvpncfgen():
    """Runs the OpenVPN config generator."""

    LOGGER.info('Generating configuration.')
    generate_configs()

    try:
        systemctl('restart', OPENVPN_SERVICE)
    except CalledProcessError:
        return False

    return True

#! /usr/bin/env python3
#
#  Multi purpose terminal maintenance utility
#
#  Maintainer: Richard Neumann <r.neumann@homeinfo.de>
#
######################################################
"""termutil

Check terminal screen resolutions

Usage:
    termutil (chkres) [<expr>]
"""

from sys import stderr

from docopt import docopt

from homeinfo.terminals.db import Terminal
from homeinfo.terminals.filter import TerminalFilter
from homeinfo.terminals.ctrl import RemoteController


def chkres(options):
    """Checks terminal screen resolutions"""
    expr = options['<expr>']
    if expr is None:
        terminals = Terminal.select().where(
            (Terminal.deployed == 1) & (Terminal.testing == 0))
    else:
        terminals = TerminalFilter(expr)
    for terminal in terminals:
        ctrl = RemoteController('homeinfo', terminal)
        remote_cmd = 'export DISPLAY=:0 \; xrandr | grep " connected"'
        pr = ctrl.execute(remote_cmd)
        if pr:
            print('Resolution on: ', terminal, '\t',
                  pr.stdout.decode().strip(), sep='')
        else:
            print('Could not determine resolution on: ', terminal,
                  ':\n', pr.stderr.decode().strip(), sep='', file=stderr)


if __name__ == '__main__':
    options = docopt(__doc__)
    if options['chkres']:
        chkres(options)
